function [C,B,b]=changeOfBasis(p,t,n,m)
%% reference: 
%V´?ctor Dom´?nguezand and Francisco-Javier Sayas. 
%Algorithm 884: A simple matlab implementation of the argyris element. 
%Acm Transactions on Mathematical Software, 35(2):1?11, 2008.
%% aim:
% get the matrix C to convert the coeffients on the reference element to a
% general element

%%
[B,b]=afftrans(p);
C=inv(B);
%%  D
H=[B(1,1)^2, B(2,1)^2, B(3,1)^2, 2*B(3,1)*B(1,1), 2*B(1,1)*B(2,1), 2*B(3,1)*B(2,1);...
   B(1,2)^2, B(2,2)^2, B(3,2)^2, 2*B(3,2)*B(1,2), 2*B(1,2)*B(2,2), 2*B(3,2)*B(2,2);...
   B(1,3)^2, B(2,3)^2, B(3,3)^2, 2*B(3,3)*B(1,3), 2*B(1,3)*B(2,3), 2*B(3,3)*B(2,3);...
   B(1,1)*B(1,3), B(2,1)*B(2,3), B(3,1)*B(3,3), B(3,1)*B(1,3)+B(3,3)*B(1,1), B(1,3)*B(2,1)+B(1,1)*B(2,3), B(3,1)*B(2,3)+B(3,3)*B(2,1);...
   B(1,1)*B(1,2), B(2,1)*B(2,2), B(3,1)*B(3,2), B(3,1)*B(1,2)+B(3,2)*B(1,1), B(1,2)*B(2,1)+B(1,1)*B(2,2), B(3,1)*B(2,2)+B(3,2)*B(2,1);...
   B(1,2)*B(1,3), B(2,2)*B(2,3), B(3,2)*B(3,3), B(3,2)*B(1,3)+B(3,3)*B(1,2), B(1,3)*B(2,2)+B(1,2)*B(2,3), B(3,2)*B(2,3)+B(3,3)*B(2,2);...
   ];

hat_t_e=[1,0,0;0,1,0;0,0,1;-1,1,0;-1,0,1;0,-1,1];
hat_n_e=[0,1,0;1,0,0;1,0,0;0,0,1;  0,1,0;1,0,0];
hat_m_e=[0,0,1;0,0,1;0,1,0;1,1,0;  1,0,1;0,1,1];

t_e=B*[1,0,0;0,1,0;0,0,1;-1,1,0;-1,0,1;0,-1,1]';
l=sum(abs(t_e).^2,1).^(1/2);

G=zeros(5,9,6);
 
for k=1:6
hat_t=(hat_t_e(k,:))';
hat_n=(hat_n_e(k,:))';  
hat_m=(hat_m_e(k,:))';
Binv_hat_t=C'*hat_t;
B_hat_n=B*hat_n;
B_hat_m=B*hat_m;

v1=[t(k,:);n(k,:);m(k,:)]'\Binv_hat_t;
v2=[t(k,:);n(k,:);m(k,:)]'\B_hat_n;
v3=[t(k,:);n(k,:);m(k,:)]'\B_hat_m;


G(1,:,k)=kron(v2.',v1.');
G(4,:,k)=kron(v3.',v1.');

Binv_hat_n=C'*hat_n;
v1=[t(k,:);n(k,:);m(k,:)]'\Binv_hat_n;
G(2,:,k)=kron(v2.',v1.');
G(5,:,k)=kron(v3.',v1.');

Binv_hat_m=C'*hat_m;
v1=[t(k,:);n(k,:);m(k,:)]'\Binv_hat_m;
G(3,:,k)=kron(v2.',v1.');

end
 
hat_t1_f=[-1,1,0;0,1,0;1,0,0;1,0,0];
hat_t2_f=[-1,0,1;0,0,1;0,0,1;0,1,0];

t1_f=[t(4,:);t(2,:);t(1,:);t(1,:)];
t2_f=[t(5,:);t(3,:);t(3,:);t(2,:)];

S=zeros(4,1);
F=zeros(2,3,4);
for k=1:4
hat_t1=(hat_t1_f(k,:))';
hat_t2=(hat_t2_f(k,:))';  

Binv_hat_t1=C'*hat_t1;
Binv_hat_t2=C'*hat_t2;


t1=(t1_f(k,:))';
t2=(t2_f(k,:))';
nn=cross(t1,t2);
S(k)=norm(cross(B*hat_t1,B*hat_t2),2)/2;
nn=nn/norm(nn,2);
v1=[t1,t2,nn]\Binv_hat_t1;
v2=[t1,t2,nn]\Binv_hat_t2;

F(:,:,k)=[v1.';v2.'];

end

detB=det(B);
kronCB=kron(C,B');
kronCB=kronCB(1:end-1,:);
kronCH=kron(C,H);
kronCH=kronCH([2:7,9:14,16:18],:);
D=blkdiag(C,C,C,C,kronCB,kronCB,kronCB,kronCB,kronCH,kronCH,kronCH,kronCH,...
          C,C,C,C,C,C,G(:,:,1),G(:,:,1),G(:,:,2),G(:,:,2),G(:,:,3),G(:,:,3),...
          G(:,:,4),G(:,:,4),G(:,:,5),G(:,:,5),G(:,:,6),G(:,:,6),...
          F(:,:,1),F(:,:,2),F(:,:,3),F(:,:,4),eye(125)/detB);
D=D*detB;




%%    E  
%%
E=zeros(383,315);
E(1:20,1:20)=eye(20);
E(21,[13,17])=[-1,-1];
E(22:29,21:28)=eye(8);
E(30,[21,25])=[-1,-1];
E(31:38,29:36)=eye(8);
E(39,[29,33])=[-1,-1];
E(40:47,37:44)=eye(8);
E(48,[37,41])=[-1,-1];

E(50:55,45:50)=eye(6);
E(57:62,51:56)=eye(6);
E(64:66,57:59)=eye(3);
E(68:73,60:65)=eye(6);
E(75:80,66:71)=eye(6);
E(82:84,72:74)=eye(3);
E(86:91,75:80)=eye(6);
E(93:98,81:86)=eye(6);
E(100:102,87:89)=eye(3);
E(104:109,90:95)=eye(6);
E(111:116,96:101)=eye(6);
E(118:120,102:104)=eye(3);

E(49,[53,57])=[-1,-1];
E(56,[48,59])=[-1,-1];
E(63,[47,54])=[-1,-1];

E(67,[68,72])=[-1,-1];
E(74,[63,74])=[-1,-1];
E(81,[62,69])=[-1,-1];

E(85,[83,87])=[-1,-1];
E(92,[78,89])=[-1,-1];
E(99,[77,84])=[-1,-1];

E(103,[98,102])=[-1,-1];
E(110,[93,104])=[-1,-1];
E(117,[92,99])=[-1,-1];

E(121:138,105:122)=eye(18);

E(142:146,123:127)=eye(5);
E(151:155,128:132)=eye(5);

E(160:164,133:137)=eye(5);
E(169:173,138:142)=eye(5);

E(178:182,143:147)=eye(5);
E(187:191,148:152)=eye(5);

E(196:200,153:157)=eye(5);
E(205:209,158:162)=eye(5);

E(214:218,163:167)=eye(5);
E(223:227,168:172)=eye(5);

E(232:236,173:177)=eye(5);
E(241:245,178:182)=eye(5);

E([247,248,250,251,253,254,256,257],183:190)=eye(8);
E(259:383,191:315)=eye(125);
%%
C=zeros(6,8);

for i=1:6
    
C(i,1) =-(m(i,1)^2*n(i,2)^2 + m(i,1)^2*n(i,3)^2 - 2*m(i,1)*m(i,2)*n(i,1)*n(i,2) - 2*m(i,1)*m(i,3)*n(i,1)*n(i,3) + m(i,2)^2*n(i,1)^2 + m(i,2)^2*n(i,3)^2 - 2*m(i,2)*m(i,3)*n(i,2)*n(i,3) + m(i,3)^2*n(i,1)^2 + m(i,3)^2*n(i,2)^2)/(n(i,1)^2*t(i,2)^2 + n(i,1)^2*t(i,3)^2 - 2*n(i,1)*n(i,2)*t(i,1)*t(i,2) - 2*n(i,1)*n(i,3)*t(i,1)*t(i,3) + n(i,2)^2*t(i,1)^2 + n(i,2)^2*t(i,3)^2 - 2*n(i,2)*n(i,3)*t(i,2)*t(i,3) + n(i,3)^2*t(i,1)^2 + n(i,3)^2*t(i,2)^2);
C(i,2) =(m(i,2)^2*n(i,1)*t(i,1) + m(i,1)^2*n(i,2)*t(i,2) + m(i,3)^2*n(i,1)*t(i,1) + m(i,1)^2*n(i,3)*t(i,3) + m(i,3)^2*n(i,2)*t(i,2) + m(i,2)^2*n(i,3)*t(i,3) - m(i,1)*m(i,2)*n(i,1)*t(i,2) - m(i,1)*m(i,2)*n(i,2)*t(i,1) - m(i,1)*m(i,3)*n(i,1)*t(i,3) - m(i,1)*m(i,3)*n(i,3)*t(i,1) - m(i,2)*m(i,3)*n(i,2)*t(i,3) - m(i,2)*m(i,3)*n(i,3)*t(i,2))/(n(i,1)^2*t(i,2)^2 + n(i,1)^2*t(i,3)^2 - 2*n(i,1)*n(i,2)*t(i,1)*t(i,2) - 2*n(i,1)*n(i,3)*t(i,1)*t(i,3) + n(i,2)^2*t(i,1)^2 + n(i,2)^2*t(i,3)^2 - 2*n(i,2)*n(i,3)*t(i,2)*t(i,3) + n(i,3)^2*t(i,1)^2 + n(i,3)^2*t(i,2)^2);
C(i,3) =(m(i,1)*n(i,2)^2*t(i,1) + m(i,1)*n(i,3)^2*t(i,1) + m(i,2)*n(i,1)^2*t(i,2) + m(i,2)*n(i,3)^2*t(i,2) + m(i,3)*n(i,1)^2*t(i,3) + m(i,3)*n(i,2)^2*t(i,3) - m(i,1)*n(i,1)*n(i,2)*t(i,2) - m(i,2)*n(i,1)*n(i,2)*t(i,1) - m(i,1)*n(i,1)*n(i,3)*t(i,3) - m(i,3)*n(i,1)*n(i,3)*t(i,1) - m(i,2)*n(i,2)*n(i,3)*t(i,3) - m(i,3)*n(i,2)*n(i,3)*t(i,2))/(n(i,1)^2*t(i,2)^2 + n(i,1)^2*t(i,3)^2 - 2*n(i,1)*n(i,2)*t(i,1)*t(i,2) - 2*n(i,1)*n(i,3)*t(i,1)*t(i,3) + n(i,2)^2*t(i,1)^2 + n(i,2)^2*t(i,3)^2 - 2*n(i,2)*n(i,3)*t(i,2)*t(i,3) + n(i,3)^2*t(i,1)^2 + n(i,3)^2*t(i,2)^2);
C(i,4) =(m(i,2)^2*n(i,1)*t(i,1) + m(i,1)^2*n(i,2)*t(i,2) + m(i,3)^2*n(i,1)*t(i,1) + m(i,1)^2*n(i,3)*t(i,3) + m(i,3)^2*n(i,2)*t(i,2) + m(i,2)^2*n(i,3)*t(i,3) - m(i,1)*m(i,2)*n(i,1)*t(i,2) - m(i,1)*m(i,2)*n(i,2)*t(i,1) - m(i,1)*m(i,3)*n(i,1)*t(i,3) - m(i,1)*m(i,3)*n(i,3)*t(i,1) - m(i,2)*m(i,3)*n(i,2)*t(i,3) - m(i,2)*m(i,3)*n(i,3)*t(i,2))/(n(i,1)^2*t(i,2)^2 + n(i,1)^2*t(i,3)^2 - 2*n(i,1)*n(i,2)*t(i,1)*t(i,2) - 2*n(i,1)*n(i,3)*t(i,1)*t(i,3) + n(i,2)^2*t(i,1)^2 + n(i,2)^2*t(i,3)^2 - 2*n(i,2)*n(i,3)*t(i,2)*t(i,3) + n(i,3)^2*t(i,1)^2 + n(i,3)^2*t(i,2)^2);
C(i,5) =-(m(i,1)^2*t(i,2)^2 + m(i,1)^2*t(i,3)^2 - 2*m(i,1)*m(i,2)*t(i,1)*t(i,2) - 2*m(i,1)*m(i,3)*t(i,1)*t(i,3) + m(i,2)^2*t(i,1)^2 + m(i,2)^2*t(i,3)^2 - 2*m(i,2)*m(i,3)*t(i,2)*t(i,3) + m(i,3)^2*t(i,1)^2 + m(i,3)^2*t(i,2)^2)/(n(i,1)^2*t(i,2)^2 + n(i,1)^2*t(i,3)^2 - 2*n(i,1)*n(i,2)*t(i,1)*t(i,2) - 2*n(i,1)*n(i,3)*t(i,1)*t(i,3) + n(i,2)^2*t(i,1)^2 + n(i,2)^2*t(i,3)^2 - 2*n(i,2)*n(i,3)*t(i,2)*t(i,3) + n(i,3)^2*t(i,1)^2 + n(i,3)^2*t(i,2)^2);
C(i,6) =(m(i,1)*n(i,1)*t(i,2)^2 + m(i,1)*n(i,1)*t(i,3)^2 + m(i,2)*n(i,2)*t(i,1)^2 + m(i,2)*n(i,2)*t(i,3)^2 + m(i,3)*n(i,3)*t(i,1)^2 + m(i,3)*n(i,3)*t(i,2)^2 - m(i,1)*n(i,2)*t(i,1)*t(i,2) - m(i,2)*n(i,1)*t(i,1)*t(i,2) - m(i,1)*n(i,3)*t(i,1)*t(i,3) - m(i,3)*n(i,1)*t(i,1)*t(i,3) - m(i,2)*n(i,3)*t(i,2)*t(i,3) - m(i,3)*n(i,2)*t(i,2)*t(i,3))/(n(i,1)^2*t(i,2)^2 + n(i,1)^2*t(i,3)^2 - 2*n(i,1)*n(i,2)*t(i,1)*t(i,2) - 2*n(i,1)*n(i,3)*t(i,1)*t(i,3) + n(i,2)^2*t(i,1)^2 + n(i,2)^2*t(i,3)^2 - 2*n(i,2)*n(i,3)*t(i,2)*t(i,3) + n(i,3)^2*t(i,1)^2 + n(i,3)^2*t(i,2)^2);
C(i,7) =(m(i,1)*n(i,2)^2*t(i,1) + m(i,1)*n(i,3)^2*t(i,1) + m(i,2)*n(i,1)^2*t(i,2) + m(i,2)*n(i,3)^2*t(i,2) + m(i,3)*n(i,1)^2*t(i,3) + m(i,3)*n(i,2)^2*t(i,3) - m(i,1)*n(i,1)*n(i,2)*t(i,2) - m(i,2)*n(i,1)*n(i,2)*t(i,1) - m(i,1)*n(i,1)*n(i,3)*t(i,3) - m(i,3)*n(i,1)*n(i,3)*t(i,1) - m(i,2)*n(i,2)*n(i,3)*t(i,3) - m(i,3)*n(i,2)*n(i,3)*t(i,2))/(n(i,1)^2*t(i,2)^2 + n(i,1)^2*t(i,3)^2 - 2*n(i,1)*n(i,2)*t(i,1)*t(i,2) - 2*n(i,1)*n(i,3)*t(i,1)*t(i,3) + n(i,2)^2*t(i,1)^2 + n(i,2)^2*t(i,3)^2 - 2*n(i,2)*n(i,3)*t(i,2)*t(i,3) + n(i,3)^2*t(i,1)^2 + n(i,3)^2*t(i,2)^2);
C(i,8) =(m(i,1)*n(i,1)*t(i,2)^2 + m(i,1)*n(i,1)*t(i,3)^2 + m(i,2)*n(i,2)*t(i,1)^2 + m(i,2)*n(i,2)*t(i,3)^2 + m(i,3)*n(i,3)*t(i,1)^2 + m(i,3)*n(i,3)*t(i,2)^2 - m(i,1)*n(i,2)*t(i,1)*t(i,2) - m(i,2)*n(i,1)*t(i,1)*t(i,2) - m(i,1)*n(i,3)*t(i,1)*t(i,3) - m(i,3)*n(i,1)*t(i,1)*t(i,3) - m(i,2)*n(i,3)*t(i,2)*t(i,3) - m(i,3)*n(i,2)*t(i,2)*t(i,3))/(n(i,1)^2*t(i,2)^2 + n(i,1)^2*t(i,3)^2 - 2*n(i,1)*n(i,2)*t(i,1)*t(i,2) - 2*n(i,1)*n(i,3)*t(i,1)*t(i,3) + n(i,2)^2*t(i,1)^2 + n(i,2)^2*t(i,3)^2 - 2*n(i,2)*n(i,3)*t(i,2)*t(i,3) + n(i,3)^2*t(i,1)^2 + n(i,3)^2*t(i,2)^2);
 
end

%%
v1=zeros(6,3);
v2=zeros(6,8);
v3=zeros(6,15);
v4=zeros(6,3);
v5=zeros(6,8);
v6=zeros(6,15);
v7=zeros(6,3);
v8=zeros(6,8);
v9=zeros(6,15);

for i=1:6
    v1(i,:)=t(i,:);
    temp=kron(t(i,:),t(i,:));
    temp(1)=temp(1)-temp(end);
    temp(5)=temp(5)-temp(end);
    v2(i,:)=l(i)*temp(1:8);
    
    v3(i,:)=l(i)^2*[t(i,1)*t(i,2)^2,t(i,3)^2*t(i,1),2*t(i,3)*t(i,1)*t(i,1)-t(i,3)^2*t(i,3),...
        2*t(i,1)*t(i,1)*t(i,2)-t(i,2)^2*t(i,2), 2*t(i,1)*t(i,2)*t(i,3), t(i,1)^2*t(i,2),...
        t(i,3)^2*t(i,2),2*t(i,1)*t(i,2)*t(i,3),2*t(i,1)*t(i,2)*t(i,2)-t(i,1)^2*t(i,1),...
        2*t(i,3)*t(i,2)*t(i,2)-t(i,3)^2*t(i,3),t(i,1)^2*t(i,3),t(i,2)^2*t(i,3),...
        2*t(i,1)*t(i,3)*t(i,3)-t(i,1)^2*t(i,1), 2*t(i,1)*t(i,2)*t(i,3),2*t(i,3)*t(i,3)*t(i,2)-t(i,2)^2*t(i,2)];
    
    v4(i,:)=n(i,:);
    temp=kron(n(i,:),t(i,:));
    temp(1)=temp(1)-temp(end);
    temp(5)=temp(5)-temp(end);
    v5(i,:)=l(i)*temp(1:8);
    
    v6(i,:)=l(i)^2*[n(i,1)*t(i,2)^2,t(i,3)^2*n(i,1),2*t(i,3)*t(i,1)*n(i,1)-t(i,3)^2*n(i,3),...
        2*t(i,1)*n(i,1)*t(i,2)-t(i,2)^2*n(i,2), 2*n(i,1)*t(i,2)*t(i,3), t(i,1)^2*n(i,2),...
        t(i,3)^2*n(i,2),2*t(i,1)*n(i,2)*t(i,3),2*t(i,1)*t(i,2)*n(i,2)-t(i,1)^2*n(i,1),...
        2*t(i,3)*t(i,2)*n(i,2)-t(i,3)^2*n(i,3),t(i,1)^2*n(i,3),t(i,2)^2*n(i,3),...
        2*t(i,1)*t(i,3)*n(i,3)-t(i,1)^2*n(i,1), 2*t(i,1)*t(i,2)*n(i,3),2*t(i,3)*n(i,3)*t(i,2)-t(i,2)^2*n(i,2)];
    
    v7(i,:)=m(i,:);
    temp=kron(m(i,:),t(i,:));
    temp(1)=temp(1)-temp(end);
    temp(5)=temp(5)-temp(end);
    v8(i,:)=l(i)*temp(1:8);
    
    v9(i,:)=l(i)^2*[m(i,1)*t(i,2)^2,t(i,3)^2*m(i,1),2*t(i,3)*t(i,1)*m(i,1)-t(i,3)^2*m(i,3),...
        2*t(i,1)*m(i,1)*t(i,2)-t(i,2)^2*m(i,2), 2*m(i,1)*t(i,2)*t(i,3), t(i,1)^2*m(i,2),...
        t(i,3)^2*m(i,2),2*t(i,1)*m(i,2)*t(i,3),2*t(i,1)*t(i,2)*m(i,2)-t(i,1)^2*m(i,1),...
        2*t(i,3)*t(i,2)*m(i,2)-t(i,3)^2*m(i,3),t(i,1)^2*m(i,3),t(i,2)^2*m(i,3),...
        2*t(i,1)*t(i,3)*m(i,3)-t(i,1)^2*m(i,1), 2*t(i,1)*t(i,2)*m(i,3),2*t(i,3)*m(i,3)*t(i,2)-t(i,2)^2*m(i,2)];


end
%% e1
E([139,140,141],[1,2,3,4,5,6,105,106,107,13:20,21:28,45:59])=...
    [-248/81*v1(1,:),-8/81*v1(1,:),256/81*v1(1,:),-40/81*v2(1,:),1/81*v2(1,:),-2/81*v3(1,:);...
     -248/81*v4(1,:),-8/81*v4(1,:),256/81*v4(1,:),-40/81*v5(1,:),1/81*v5(1,:),-2/81*v6(1,:);...
     -248/81*v7(1,:),-8/81*v7(1,:),256/81*v7(1,:),-40/81*v8(1,:),1/81*v8(1,:),-2/81*v9(1,:)]/l(1);


E([148,149,150],[1,2,3,4,5,6,105,106,107,13:20,21:28,60:74])=...
    [8/81*v1(1,:),248/81*v1(1,:),-256/81*v1(1,:),1/81*v2(1,:),-40/81*v2(1,:),2/81*v3(1,:);...
     8/81*v4(1,:),248/81*v4(1,:),-256/81*v4(1,:),1/81*v5(1,:),-40/81*v5(1,:),2/81*v6(1,:);...
     8/81*v7(1,:),248/81*v7(1,:),-256/81*v7(1,:),1/81*v8(1,:),-40/81*v8(1,:),2/81*v9(1,:)]/l(1);

 
E(147,[1,2,3,4,5,6,105,106,107,13:20,21:28,45:59,123:127])=...
    [C(1,1)*[-248/81*v1(1,:),-8/81*v1(1,:),256/81*v1(1,:),-40/81*v2(1,:),1/81*v2(1,:),-2/81*v3(1,:)]/l(1)+...
     C(1,4)*[-248/81*v4(1,:),-8/81*v4(1,:),256/81*v4(1,:),-40/81*v5(1,:),1/81*v5(1,:),-2/81*v6(1,:)]/l(1)+...
     C(1,7)*[-248/81*v7(1,:),-8/81*v7(1,:),256/81*v7(1,:),-40/81*v8(1,:),1/81*v8(1,:),-2/81*v9(1,:)]/l(1),...
     C(1,2),C(1,5),C(1,8),C(1,3),C(1,6)];

E(156,[1,2,3,4,5,6,105,106,107,13:20,21:28,60:74,128:132])=...
    [C(1,1)*[8/81*v1(1,:),248/81*v1(1,:),-256/81*v1(1,:),1/81*v2(1,:),-40/81*v2(1,:),2/81*v3(1,:)]/l(1)+...
     C(1,4)*[8/81*v4(1,:),248/81*v4(1,:),-256/81*v4(1,:),1/81*v5(1,:),-40/81*v5(1,:),2/81*v6(1,:)]/l(1)+...
     C(1,7)*[8/81*v7(1,:),248/81*v7(1,:),-256/81*v7(1,:),1/81*v8(1,:),-40/81*v8(1,:),2/81*v9(1,:)]/l(1),...
     C(1,2),C(1,5),C(1,8),C(1,3),C(1,6)];
 
%% e2
E([157,158,159],[1,2,3,7,8,9,108,109,110,13:20,29:36,45:59])=...
    [-248/81*v1(2,:),-8/81*v1(2,:),256/81*v1(2,:),-40/81*v2(2,:),1/81*v2(2,:),-2/81*v3(2,:);...
     -248/81*v4(2,:),-8/81*v4(2,:),256/81*v4(2,:),-40/81*v5(2,:),1/81*v5(2,:),-2/81*v6(2,:);...
     -248/81*v7(2,:),-8/81*v7(2,:),256/81*v7(2,:),-40/81*v8(2,:),1/81*v8(2,:),-2/81*v9(2,:)]/l(2);


E([166,167,168],[1,2,3,7,8,9,108,109,110,13:20,29:36,75:89])=...
    [8/81*v1(2,:),248/81*v1(2,:),-256/81*v1(2,:),1/81*v2(2,:),-40/81*v2(2,:),2/81*v3(2,:);...
     8/81*v4(2,:),248/81*v4(2,:),-256/81*v4(2,:),1/81*v5(2,:),-40/81*v5(2,:),2/81*v6(2,:);...
     8/81*v7(2,:),248/81*v7(2,:),-256/81*v7(2,:),1/81*v8(2,:),-40/81*v8(2,:),2/81*v9(2,:)]/l(2);

 
E(165,[1,2,3,7,8,9,108,109,110,13:20,29:36,45:59,133:137])=...
    [C(2,1)*[-248/81*v1(2,:),-8/81*v1(2,:),256/81*v1(2,:),-40/81*v2(2,:),1/81*v2(2,:),-2/81*v3(2,:)]/l(2)+...
     C(2,4)*[-248/81*v4(2,:),-8/81*v4(2,:),256/81*v4(2,:),-40/81*v5(2,:),1/81*v5(2,:),-2/81*v6(2,:)]/l(2)+...
     C(2,7)*[-248/81*v7(2,:),-8/81*v7(2,:),256/81*v7(2,:),-40/81*v8(2,:),1/81*v8(2,:),-2/81*v9(2,:)]/l(2),...
     C(2,2),C(2,5),C(2,8),C(2,3),C(2,6)];

E(174,[1,2,3,7,8,9,108,109,110,13:20,29:36,75:89,138:142])=...
    [C(2,1)*[8/81*v1(2,:),248/81*v1(2,:),-256/81*v1(2,:),1/81*v2(2,:),-40/81*v2(2,:),2/81*v3(2,:)]/l(2)+...
     C(2,4)*[8/81*v4(2,:),248/81*v4(2,:),-256/81*v4(2,:),1/81*v5(2,:),-40/81*v5(2,:),2/81*v6(2,:)]/l(2)+...
     C(2,7)*[8/81*v7(2,:),248/81*v7(2,:),-256/81*v7(2,:),1/81*v8(2,:),-40/81*v8(2,:),2/81*v9(2,:)]/l(2),...
     C(2,2),C(2,5),C(2,8),C(2,3),C(2,6)];
 
 
%% e3

E([175,176,177],[1,2,3,10,11,12,111,112,113,13:20,37:44,45:59])=...
    [-248/81*v1(3,:),-8/81*v1(3,:),256/81*v1(3,:),-40/81*v2(3,:),1/81*v2(3,:),-2/81*v3(3,:);...
     -248/81*v4(3,:),-8/81*v4(3,:),256/81*v4(3,:),-40/81*v5(3,:),1/81*v5(3,:),-2/81*v6(3,:);...
     -248/81*v7(3,:),-8/81*v7(3,:),256/81*v7(3,:),-40/81*v8(3,:),1/81*v8(3,:),-2/81*v9(3,:)]/l(3);


E([184,185,186],[1,2,3,10,11,12,111,112,113,13:20,37:44,90:104])=...
     [8/81*v1(3,:),248/81*v1(3,:),-256/81*v1(3,:),1/81*v2(3,:),-40/81*v2(3,:),2/81*v3(3,:);...
     8/81*v4(3,:),248/81*v4(3,:),-256/81*v4(3,:),1/81*v5(3,:),-40/81*v5(3,:),2/81*v6(3,:);...
     8/81*v7(3,:),248/81*v7(3,:),-256/81*v7(3,:),1/81*v8(3,:),-40/81*v8(3,:),2/81*v9(3,:)]/l(3);
 
E(183,[1,2,3,10,11,12,111,112,113,13:20,37:44,45:59,143:147])=...
    [C(3,1)*[-248/81*v1(3,:),-8/81*v1(3,:),256/81*v1(3,:),-40/81*v2(3,:),1/81*v2(3,:),-2/81*v3(3,:)]/l(3)+...
    C(3,4)*[-248/81*v4(3,:),-8/81*v4(3,:),256/81*v4(3,:),-40/81*v5(3,:),1/81*v5(3,:),-2/81*v6(3,:)]/l(3)+...
    C(3,7)*[-248/81*v7(3,:),-8/81*v7(3,:),256/81*v7(3,:),-40/81*v8(3,:),1/81*v8(3,:),-2/81*v9(3,:)]/l(3),...
    C(3,2),C(3,5),C(3,8),C(3,3),C(3,6)];

E(192,[1,2,3,10,11,12,111,112,113,13:20,37:44,90:104,148:152])=...
    [C(3,1)*[8/81*v1(3,:),248/81*v1(3,:),-256/81*v1(3,:),1/81*v2(3,:),-40/81*v2(3,:),2/81*v3(3,:)]/l(3)+...
     C(3,4)*[8/81*v4(3,:),248/81*v4(3,:),-256/81*v4(3,:),1/81*v5(3,:),-40/81*v5(3,:),2/81*v6(3,:)]/l(3)+...
     C(3,7)*[8/81*v7(3,:),248/81*v7(3,:),-256/81*v7(3,:),1/81*v8(3,:),-40/81*v8(3,:),2/81*v9(3,:)]/l(3),...
    C(3,2),C(3,5),C(3,8),C(3,3),C(3,6)];



%% e4

E([193,194,195],[4,5,6,7,8,9,114,115,116,21:28,29:36,60:74])=...
    [-248/81*v1(4,:),-8/81*v1(4,:),256/81*v1(4,:),-40/81*v2(4,:),1/81*v2(4,:),-2/81*v3(4,:);...
     -248/81*v4(4,:),-8/81*v4(4,:),256/81*v4(4,:),-40/81*v5(4,:),1/81*v5(4,:),-2/81*v6(4,:);...
     -248/81*v7(4,:),-8/81*v7(4,:),256/81*v7(4,:),-40/81*v8(4,:),1/81*v8(4,:),-2/81*v9(4,:)]/l(4);


E([202,203,204],[4,5,6,7,8,9,114,115,116,21:28,29:36,75:89])=...
    [8/81*v1(4,:),248/81*v1(4,:),-256/81*v1(4,:),1/81*v2(4,:),-40/81*v2(4,:),2/81*v3(4,:);...
     8/81*v4(4,:),248/81*v4(4,:),-256/81*v4(4,:),1/81*v5(4,:),-40/81*v5(4,:),2/81*v6(4,:);...
     8/81*v7(4,:),248/81*v7(4,:),-256/81*v7(4,:),1/81*v8(4,:),-40/81*v8(4,:),2/81*v9(4,:)]/l(4);
 
 
E(201,[4,5,6,7,8,9,114,115,116,21:28,29:36,60:74,153:157])=...
    [C(4,1)*[-248/81*v1(4,:),-8/81*v1(4,:),256/81*v1(4,:),-40/81*v2(4,:),1/81*v2(4,:),-2/81*v3(4,:)]/l(4)+...
    C(4,4)*[-248/81*v4(4,:),-8/81*v4(4,:),256/81*v4(4,:),-40/81*v5(4,:),1/81*v5(4,:),-2/81*v6(4,:)]/l(4)+...
    C(4,7)*[-248/81*v7(4,:),-8/81*v7(4,:),256/81*v7(4,:),-40/81*v8(4,:),1/81*v8(4,:),-2/81*v9(4,:)]/l(4),...
    C(4,2),C(4,5),C(4,8),C(4,3),C(4,6)];

E(210,[4,5,6,7,8,9,114,115,116,21:28,29:36,75:89,158:162])=...
    [C(4,1)*[8/81*v1(4,:),248/81*v1(4,:),-256/81*v1(4,:),1/81*v2(4,:),-40/81*v2(4,:),2/81*v3(4,:)]/l(4)+...
     C(4,4)*[8/81*v4(4,:),248/81*v4(4,:),-256/81*v4(4,:),1/81*v5(4,:),-40/81*v5(4,:),2/81*v6(4,:)]/l(4)+...
     C(4,7)*[8/81*v7(4,:),248/81*v7(4,:),-256/81*v7(4,:),1/81*v8(4,:),-40/81*v8(4,:),2/81*v9(4,:)]/l(4),...
    C(4,2),C(4,5),C(4,8),C(4,3),C(4,6)];

 
%% e5

E([211,212,213],[4,5,6,10,11,12,117,118,119,21:28,37:44,60:74])=...
     [-248/81*v1(5,:),-8/81*v1(5,:),256/81*v1(5,:),-40/81*v2(5,:),1/81*v2(5,:),-2/81*v3(5,:);...
     -248/81*v4(5,:),-8/81*v4(5,:),256/81*v4(5,:),-40/81*v5(5,:),1/81*v5(5,:),-2/81*v6(5,:);...
     -248/81*v7(5,:),-8/81*v7(5,:),256/81*v7(5,:),-40/81*v8(5,:),1/81*v8(5,:),-2/81*v9(5,:)]/l(5);


E([220,221,222],[4,5,6,10,11,12,117,118,119,21:28,37:44,90:104])=...
    [8/81*v1(5,:),248/81*v1(5,:),-256/81*v1(5,:),1/81*v2(5,:),-40/81*v2(5,:),2/81*v3(5,:);...
     8/81*v4(5,:),248/81*v4(5,:),-256/81*v4(5,:),1/81*v5(5,:),-40/81*v5(5,:),2/81*v6(5,:);...
     8/81*v7(5,:),248/81*v7(5,:),-256/81*v7(5,:),1/81*v8(5,:),-40/81*v8(5,:),2/81*v9(5,:)]/l(5);
 
 
 
E(219,[4,5,6,10,11,12,117,118,119,21:28,37:44,60:74,163:167])=...
    [C(5,1)*[-248/81*v1(5,:),-8/81*v1(5,:),256/81*v1(5,:),-40/81*v2(5,:),1/81*v2(5,:),-2/81*v3(5,:)]/l(5)+...
    C(5,4)*[-248/81*v4(5,:),-8/81*v4(5,:),256/81*v4(5,:),-40/81*v5(5,:),1/81*v5(5,:),-2/81*v6(5,:)]/l(5)+...
    C(5,7)*[-248/81*v7(5,:),-8/81*v7(5,:),256/81*v7(5,:),-40/81*v8(5,:),1/81*v8(5,:),-2/81*v9(5,:)]/l(5),...
    C(5,2),C(5,5),C(5,8),C(5,3),C(5,6)];


E(228,[4,5,6,10,11,12,117,118,119,21:28,37:44,90:104,168:172])=...
    [C(5,1)*[8/81*v1(5,:),248/81*v1(5,:),-256/81*v1(5,:),1/81*v2(5,:),-40/81*v2(5,:),2/81*v3(5,:)]/l(5)+...
     C(5,4)*[8/81*v4(5,:),248/81*v4(5,:),-256/81*v4(5,:),1/81*v5(5,:),-40/81*v5(5,:),2/81*v6(5,:)]/l(5)+...
     C(5,7)*[8/81*v7(5,:),248/81*v7(5,:),-256/81*v7(5,:),1/81*v8(5,:),-40/81*v8(5,:),2/81*v9(5,:)]/l(5),...
   C(5,2),C(5,5),C(5,8),C(5,3),C(5,6)];


 
%% e6

E([229,230,231],[7,8,9,10,11,12,120,121,122,29:36,37:44,75:89])=...
    [-248/81*v1(6,:),-8/81*v1(6,:),256/81*v1(6,:),-40/81*v2(6,:),1/81*v2(6,:),-2/81*v3(6,:);...
     -248/81*v4(6,:),-8/81*v4(6,:),256/81*v4(6,:),-40/81*v5(6,:),1/81*v5(6,:),-2/81*v6(6,:);...
     -248/81*v7(6,:),-8/81*v7(6,:),256/81*v7(6,:),-40/81*v8(6,:),1/81*v8(6,:),-2/81*v9(6,:)]/l(6);


E([238,239,240],[7,8,9,10,11,12,120,121,122,29:36,37:44,90:104])=...
    [8/81*v1(6,:),248/81*v1(6,:),-256/81*v1(6,:),1/81*v2(6,:),-40/81*v2(6,:),2/81*v3(6,:);...
     8/81*v4(6,:),248/81*v4(6,:),-256/81*v4(6,:),1/81*v5(6,:),-40/81*v5(6,:),2/81*v6(6,:);...
     8/81*v7(6,:),248/81*v7(6,:),-256/81*v7(6,:),1/81*v8(6,:),-40/81*v8(6,:),2/81*v9(6,:)]/l(6);
 
E(237,[7,8,9,10,11,12,120,121,122,29:36,37:44,75:89,173:177])=...
    [C(6,1)*[-248/81*v1(6,:),-8/81*v1(6,:),256/81*v1(6,:),-40/81*v2(6,:),1/81*v2(6,:),-2/81*v3(6,:)]/l(6)+...
    C(6,4)*[-248/81*v4(6,:),-8/81*v4(6,:),256/81*v4(6,:),-40/81*v5(6,:),1/81*v5(6,:),-2/81*v6(6,:)]/l(6)+...
    C(6,7)*[-248/81*v7(6,:),-8/81*v7(6,:),256/81*v7(6,:),-40/81*v8(6,:),1/81*v8(6,:),-2/81*v9(6,:)]/l(6),...
    C(6,2),C(6,5),C(6,8),C(6,3),C(6,6)];


E(246,[7,8,9,10,11,12,120,121,122,29:36,37:44,90:104,178:182])=...
    [C(6,1)*[8/81*v1(6,:),248/81*v1(6,:),-256/81*v1(6,:),1/81*v2(6,:),-40/81*v2(6,:),2/81*v3(6,:)]/l(6)+...
     C(6,4)*[8/81*v4(6,:),248/81*v4(6,:),-256/81*v4(6,:),1/81*v5(6,:),-40/81*v5(6,:),2/81*v6(6,:)]/l(6)+...
     C(6,7)*[8/81*v7(6,:),248/81*v7(6,:),-256/81*v7(6,:),1/81*v8(6,:),-40/81*v8(6,:),2/81*v9(6,:)]/l(6),...
     C(6,2),C(6,5),C(6,8),C(6,3),C(6,6)];


%%
E(249,[212,219,226])=...
    [1/S(1),-1/S(1),1/S(1)];

E(252,[198,205,226])=...
    [1/S(2),-1/S(2),1/S(2)];

E(255,[191,205,219])=...
    [1/S(3),-1/S(3),1/S(3)];

E(258,[191,198,212])=...
    [1/S(4),-1/S(4),1/S(4)];

 C=D*E;
 

% temp=[find(C(:,2)~=0)].'
% C(temp,2)
% for i=1:315
%     find(C(i,:)>1d-8)
% end

function [B,b]=afftrans(p)
B=[p(1,2)-p(1,1),p(1,3)-p(1,1),p(1,4)-p(1,1);...
   p(2,2)-p(2,1),p(2,3)-p(2,1),p(2,4)-p(2,1);...
   p(3,2)-p(3,1),p(3,3)-p(3,1),p(3,4)-p(3,1)];
b=[p(1,1);p(2,1);p(3,1)];
end
end